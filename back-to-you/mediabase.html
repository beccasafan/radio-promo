<!DOCTYPE html>
<html>

<head>
    <title>Back to You - Mediabase Request Generator</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <style>
        iframe {
            display: none;
        }
        
        #error {
            display: none;
            color: red;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="shared-form">
            <div class="form-group">
                <label for="username">Name</label>
                <input type="text" class="form-control" placeholder="Name" name="username" id="username" required />
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" placeholder="Email" name="email" id="email" required />
            </div>
            <div class="form-group">
                <label for="sex">Sex</label>
                <select class="form-control" name="sex" id="sex" required>
                    <option>Choose...</option>
                    <option>female</option>
                    <option>male</option>
                </select>
            </div>
            <div class="form-group">
                <label for="age">Age</label>
                <input type="number" class="form-control" placeholder="Age" name="age" id="age" required />
            </div>

            <div id="error">Please fill in all fields with valid data</div>
            <button type="button" class="btn btn-primary" data-bind="click: formFilledIn">Next</button>
        </div>
        <!-- ko if: hasFilledInForm -->
        <div id="stations" data-bind="foreach: stations">
            <div data-bind="text: station, click: $parent.loadStation"></div>
            <iframe src="" data-bind="attr: { 'data-station': station, id: 'station-' + station }, event: { load: $parent.stationLoaded }"></iframe>
            <br />
        </div>
        <!-- /ko -->

    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.2/lodash.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-min.js" type="text/javascript"></script>

    <script>
        var ViewModel = (function() {
            function ViewModel() {
                var spreadsheetId = "1YRHeDX4xn9r2lYe8qeh0a7F3h1KP4eGl3cGFAPg25i4";
                var sheetId = "od6";

                var self = this;
                this.stations = ko.observableArray();
                this.hasFilledInForm = ko.observable(false);

                var getVal = function (entry, key) { return entry["gsx$" + key].$t; };
                var stationsTask = $.getJSON("https://spreadsheets.google.com/feeds/list/" + spreadsheetId + "/" + sheetId + "/public/full?alt=json").done(function(json) {
                    self.stations(_.filter(_.map(json.feed.entry, function(s) { return {station: getVal(s, "station"), community: getVal(s, "city") + ", " + getVal(s, "state"), zip: getVal(s, "zip"), added: getVal(s, "added")}}), function(s) { return s.station == "KYKY-FM"}));
                });   
            }

            ViewModel.prototype.stationLoaded = function(station) {
                var user = {
                    username: $("#username").val(),
                    email: $("#email").val(),
                    age: $("#age").val(),
                    sex: $("#sex").val(),
                };
                
                $("#station-" + station.station)[0].contentWindow.postMessage({ station: station, user: user }, "*");
            };

            ViewModel.prototype.loadStation = function(station) {
                $("#station-" + station.station).attr("src", "mediabasestation.html").show();
            };

            ViewModel.prototype.formFilledIn = function() {
                var username = $("#username").val();
                var email = $("#email").val();
                var age = $("#age").val();
                var sex = $("#sex").val();

                if (_.isEmpty(username) || _.isEmpty(email) || _.isEmpty(age) || _.isEmpty(sex)) {
                    $("#error").show();
                } else {
                    $("#error").hide();   
                    this.hasFilledInForm(true);
                }
            };

            return ViewModel;
        })();

        var vm = new ViewModel();
        ko.applyBindings(vm, $("body")[0]);
    </script>
</body>

</html>
